{"pageProps":{"postData":{"id":"post01","year":"2021","month":"08","date":"17","contentHtml":"<p>ところどころつまずいたので残します．</p>\n<h2 id=\"目次\">目次</h2>\n<ul>\n<li><a href=\"#lan-net-%E3%81%A8%E3%81%84%E3%81%86%E9%A0%85%E7%9B%AE\">LAN net という項目</a></li>\n<li><a href=\"#%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">自動生成されるファイアウォールルールを確認する</a></li>\n<li><a href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E9%A0%86%E7%95%AA%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">ファイアウォールルールの順番確認する</a></li>\n<li><a href=\"#nat%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\">NATルールを確認する</a></li>\n<li><a href=\"#web-gui%E3%81%AB%E7%B9%8B%E3%81%92%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%8D\">WEB GUIに繋げなくなったとき</a></li>\n<li><a href=\"#%E5%90%8C%E3%81%98%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%82%A4%E3%82%B9%E3%81%AB%E6%8C%AF%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\">同じネットワークのアドレスをインターフェイスに振ってはいけない</a></li>\n</ul>\n<h2 id=\"lan-net-という項目\">LAN net という項目</h2>\n<p>例えば，LAN という名前のインターフェイスがあったとき，ファイアウォールのルールの Source や Destination の選択肢で「LAN address」や「LAN net」という項目が選べます．</p>\n<p>この LAN net というのは <strong>LAN インターフェイスが所属するネットワークだけ</strong>を指し，それより下のネットワークのことではないです．</p>\n<p>例えば、下図のように，LAN net が 192.0.2.0/24 であるとします．そのとき、送信先が LAN net のパケットを Reject する項目を追加しても，192.0.2.0/24 しか Reject しません．<br>\nつまり，下図のルータの下に 192.0.2.0/24 以外のネットワークがあったとしても，そのネットワークは LAN net の対象ではないということです．</p>\n<p><img src=\"/assets/2021081701/opnsense-1.png\" alt=\"図1\"></p>\n<h2 id=\"自動生成されるファイアウォールルールを確認する\">自動生成されるファイアウォールルールを確認する</h2>\n<p>自動生成されるルールはウェブページを開いたときに隠れているので，表示して確認します．</p>\n<p><img src=\"/assets/2021081701/opnsense-2.png\" alt=\"図2\"></p>\n<p>ここにトラブルの原因があるかも知れません．</p>\n<h2 id=\"ファイアウォールルールの順番確認する\">ファイアウォールルールの順番確認する</h2>\n<p>まずはドキュメントを参照するといいです．<br>\n<a href=\"https://docs.opnsense.org/manual/firewall.html\">https://docs.opnsense.org/manual/firewall.html</a></p>\n<p>ドキュメントによると，ファイアウォールは次の順番で評価されます．</p>\n<ol>\n<li>Floating ( 全インタフェイス ) での設定</li>\n<li>グループでの設定</li>\n<li>インターフェイスごとの設定</li>\n</ol>\n<p><strong>表の上のものが優先されて</strong>評価されます．</p>\n<h2 id=\"natルールを確認する\">NATルールを確認する</h2>\n<p>恐らくデフォルトで有効になっています．</p>\n<p>NAT しない場合は「Disable outbound NAT rule generation」を選択するといいです．</p>\n<p><img src=\"/assets/2021081701/opnsense-3.png\" alt=\"図3\"></p>\n<h2 id=\"web-guiに繋げなくなったとき\">WEB GUIに繋げなくなったとき</h2>\n<p>ファイアウォールの設定を消してしまい，WEB GUI への接続がはじかれてしまったときの対処法を説明します ( CLI が使えることが前提 )．</p>\n<p><code>pfctl</code> コマンドを使って CLI から pf ( BSD 系 OS のパケットフィルタ ) の設定を行います．</p>\n<pre style=\"background: #2e3440\"><code style=\"color: undefined\">pfctl -d\n</code></pre>\n<p><code>-d</code> は disable のことで，ファイアウォールを無効にします．\nこれで WEB GUI に繋がるので、設定を再開できます．</p>\n<p>再び有効にするには WEB GUI で設定を適用するか，<code>pfctl</code> コマンドを使います．</p>\n<pre style=\"background: #2e3440\"><code style=\"color: undefined\">pfctl -e\n</code></pre>\n<p><code>-e</code> は enable のことで，ファイアウォールを有効にします．</p>\n<h2 id=\"同じネットワークのアドレスをインターフェイスに振ってはいけない\">同じネットワークのアドレスをインターフェイスに振ってはいけない</h2>\n<p>2つ以上のインターフェイスに同じネットワークの IP アドレスを振ると，その設定が無効化され接続できなくなります．</p>\n<p>同じネットワークに所属させるために bridge 機能があります ( この記事では説明しませんが )．</p>","title":"OPNsense設定備忘録","created_at":"2021-08-17"}},"__N_SSG":true}