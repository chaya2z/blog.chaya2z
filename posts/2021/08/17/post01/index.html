<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="IT技術を中心としたブログ"/><meta property="og:image" content="https://github.com/chaya2z/chaya2z.github.io/blob/gh-pages/main_ogp.png?raw=true"/><meta name="og:title" content="海底タランテラ"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous"/><title>OPNsense設定備忘録</title><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/04a7f9b5f46e743e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/04a7f9b5f46e743e.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0ad87472260d4bb9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0ad87472260d4bb9.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-062c35b1bbcb9ed2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5508371544ba549e.js" defer=""></script><script src="/_next/static/chunks/395-04da106b08c8ce64.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Byear%5D/%5Bmonth%5D/%5Bdate%5D/%5Bid%5D-8e53c95a25f74456.js" defer=""></script><script src="/_next/static/IBghKQTQl9mexBDzGCP1b/_buildManifest.js" defer=""></script><script src="/_next/static/IBghKQTQl9mexBDzGCP1b/_ssgManifest.js" defer=""></script><script src="/_next/static/IBghKQTQl9mexBDzGCP1b/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header><div class="header_container__xYHxC"><h1>海底タランテラ</h1></div><div class="navbar_container__whdC7"><a class="navbar_item__jtENX" href="/">Home</a><a class="navbar_item__jtENX" href="/posts/">Posts</a><a class="navbar_item__jtENX" href="/about/">About</a></div></header><div class="layout_container__fbLkO"><main><article><h1 class="utils_headingXl__u25Y2">OPNsense設定備忘録</h1><div class="utils_lightText__eUzGY"><time dateTime="2021-08-17">August 17, 2021</time></div><div><p>ところどころつまずいたので残します．</p>
<h2 id="目次">目次</h2>
<ul>
<li><a href="#lan-net-%E3%81%A8%E3%81%84%E3%81%86%E9%A0%85%E7%9B%AE">LAN net という項目</a></li>
<li><a href="#%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">自動生成されるファイアウォールルールを確認する</a></li>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E9%A0%86%E7%95%AA%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">ファイアウォールルールの順番確認する</a></li>
<li><a href="#nat%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">NATルールを確認する</a></li>
<li><a href="#web-gui%E3%81%AB%E7%B9%8B%E3%81%92%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%8D">WEB GUIに繋げなくなったとき</a></li>
<li><a href="#%E5%90%8C%E3%81%98%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%82%A4%E3%82%B9%E3%81%AB%E6%8C%AF%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84">同じネットワークのアドレスをインターフェイスに振ってはいけない</a></li>
</ul>
<h2 id="lan-net-という項目">LAN net という項目</h2>
<p>例えば，LAN という名前のインターフェイスがあったとき，ファイアウォールのルールの Source や Destination の選択肢で「LAN address」や「LAN net」という項目が選べます．</p>
<p>この LAN net というのは <strong>LAN インターフェイスが所属するネットワークだけ</strong>を指し，それより下のネットワークのことではないです．</p>
<p>例えば、下図のように，LAN net が 192.0.2.0/24 であるとします．そのとき、送信先が LAN net のパケットを Reject する項目を追加しても，192.0.2.0/24 しか Reject しません．<br>
つまり，下図のルータの下に 192.0.2.0/24 以外のネットワークがあったとしても，そのネットワークは LAN net の対象ではないということです．</p>
<p><img src="/assets/2021081701/opnsense-1.png" alt="図1"></p>
<h2 id="自動生成されるファイアウォールルールを確認する">自動生成されるファイアウォールルールを確認する</h2>
<p>自動生成されるルールはウェブページを開いたときに隠れているので，表示して確認します．</p>
<p><img src="/assets/2021081701/opnsense-2.png" alt="図2"></p>
<p>ここにトラブルの原因があるかも知れません．</p>
<h2 id="ファイアウォールルールの順番確認する">ファイアウォールルールの順番確認する</h2>
<p>まずはドキュメントを参照するといいです．<br>
<a href="https://docs.opnsense.org/manual/firewall.html">https://docs.opnsense.org/manual/firewall.html</a></p>
<p>ドキュメントによると，ファイアウォールは次の順番で評価されます．</p>
<ol>
<li>Floating ( 全インタフェイス ) での設定</li>
<li>グループでの設定</li>
<li>インターフェイスごとの設定</li>
</ol>
<p><strong>表の上のものが優先されて</strong>評価されます．</p>
<h2 id="natルールを確認する">NATルールを確認する</h2>
<p>恐らくデフォルトで有効になっています．</p>
<p>NAT しない場合は「Disable outbound NAT rule generation」を選択するといいです．</p>
<p><img src="/assets/2021081701/opnsense-3.png" alt="図3"></p>
<h2 id="web-guiに繋げなくなったとき">WEB GUIに繋げなくなったとき</h2>
<p>ファイアウォールの設定を消してしまい，WEB GUI への接続がはじかれてしまったときの対処法を説明します ( CLI が使えることが前提 )．</p>
<p><code>pfctl</code> コマンドを使って CLI から pf ( BSD 系 OS のパケットフィルタ ) の設定を行います．</p>
<pre style="background: #2e3440"><code style="color: undefined">pfctl -d
</code></pre>
<p><code>-d</code> は disable のことで，ファイアウォールを無効にします．
これで WEB GUI に繋がるので、設定を再開できます．</p>
<p>再び有効にするには WEB GUI で設定を適用するか，<code>pfctl</code> コマンドを使います．</p>
<pre style="background: #2e3440"><code style="color: undefined">pfctl -e
</code></pre>
<p><code>-e</code> は enable のことで，ファイアウォールを有効にします．</p>
<h2 id="同じネットワークのアドレスをインターフェイスに振ってはいけない">同じネットワークのアドレスをインターフェイスに振ってはいけない</h2>
<p>2つ以上のインターフェイスに同じネットワークの IP アドレスを振ると，その設定が無効化され接続できなくなります．</p>
<p>同じネットワークに所属させるために bridge 機能があります ( この記事では説明しませんが )．</p></div></article></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div><div class="footer_container__LsEE4"><small>© 海底タランテラ chaya2z</small><div class="footer_text__veFtv">Powered by GitHub Pages</div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"post01","year":"2021","month":"08","date":"17","contentHtml":"\u003cp\u003eところどころつまずいたので残します．\u003c/p\u003e\n\u003ch2 id=\"目次\"\u003e目次\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#lan-net-%E3%81%A8%E3%81%84%E3%81%86%E9%A0%85%E7%9B%AE\"\u003eLAN net という項目\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\"\u003e自動生成されるファイアウォールルールを確認する\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E9%A0%86%E7%95%AA%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\"\u003eファイアウォールルールの順番確認する\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#nat%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\"\u003eNATルールを確認する\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#web-gui%E3%81%AB%E7%B9%8B%E3%81%92%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E3%81%A8%E3%81%8D\"\u003eWEB GUIに繋げなくなったとき\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%90%8C%E3%81%98%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%82%A4%E3%82%B9%E3%81%AB%E6%8C%AF%E3%81%A3%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\"\u003e同じネットワークのアドレスをインターフェイスに振ってはいけない\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"lan-net-という項目\"\u003eLAN net という項目\u003c/h2\u003e\n\u003cp\u003e例えば，LAN という名前のインターフェイスがあったとき，ファイアウォールのルールの Source や Destination の選択肢で「LAN address」や「LAN net」という項目が選べます．\u003c/p\u003e\n\u003cp\u003eこの LAN net というのは \u003cstrong\u003eLAN インターフェイスが所属するネットワークだけ\u003c/strong\u003eを指し，それより下のネットワークのことではないです．\u003c/p\u003e\n\u003cp\u003e例えば、下図のように，LAN net が 192.0.2.0/24 であるとします．そのとき、送信先が LAN net のパケットを Reject する項目を追加しても，192.0.2.0/24 しか Reject しません．\u003cbr\u003e\nつまり，下図のルータの下に 192.0.2.0/24 以外のネットワークがあったとしても，そのネットワークは LAN net の対象ではないということです．\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/2021081701/opnsense-1.png\" alt=\"図1\"\u003e\u003c/p\u003e\n\u003ch2 id=\"自動生成されるファイアウォールルールを確認する\"\u003e自動生成されるファイアウォールルールを確認する\u003c/h2\u003e\n\u003cp\u003e自動生成されるルールはウェブページを開いたときに隠れているので，表示して確認します．\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/2021081701/opnsense-2.png\" alt=\"図2\"\u003e\u003c/p\u003e\n\u003cp\u003eここにトラブルの原因があるかも知れません．\u003c/p\u003e\n\u003ch2 id=\"ファイアウォールルールの順番確認する\"\u003eファイアウォールルールの順番確認する\u003c/h2\u003e\n\u003cp\u003eまずはドキュメントを参照するといいです．\u003cbr\u003e\n\u003ca href=\"https://docs.opnsense.org/manual/firewall.html\"\u003ehttps://docs.opnsense.org/manual/firewall.html\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eドキュメントによると，ファイアウォールは次の順番で評価されます．\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eFloating ( 全インタフェイス ) での設定\u003c/li\u003e\n\u003cli\u003eグループでの設定\u003c/li\u003e\n\u003cli\u003eインターフェイスごとの設定\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e表の上のものが優先されて\u003c/strong\u003e評価されます．\u003c/p\u003e\n\u003ch2 id=\"natルールを確認する\"\u003eNATルールを確認する\u003c/h2\u003e\n\u003cp\u003e恐らくデフォルトで有効になっています．\u003c/p\u003e\n\u003cp\u003eNAT しない場合は「Disable outbound NAT rule generation」を選択するといいです．\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/2021081701/opnsense-3.png\" alt=\"図3\"\u003e\u003c/p\u003e\n\u003ch2 id=\"web-guiに繋げなくなったとき\"\u003eWEB GUIに繋げなくなったとき\u003c/h2\u003e\n\u003cp\u003eファイアウォールの設定を消してしまい，WEB GUI への接続がはじかれてしまったときの対処法を説明します ( CLI が使えることが前提 )．\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epfctl\u003c/code\u003e コマンドを使って CLI から pf ( BSD 系 OS のパケットフィルタ ) の設定を行います．\u003c/p\u003e\n\u003cpre style=\"background: #2e3440\"\u003e\u003ccode style=\"color: undefined\"\u003epfctl -d\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e-d\u003c/code\u003e は disable のことで，ファイアウォールを無効にします．\nこれで WEB GUI に繋がるので、設定を再開できます．\u003c/p\u003e\n\u003cp\u003e再び有効にするには WEB GUI で設定を適用するか，\u003ccode\u003epfctl\u003c/code\u003e コマンドを使います．\u003c/p\u003e\n\u003cpre style=\"background: #2e3440\"\u003e\u003ccode style=\"color: undefined\"\u003epfctl -e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e-e\u003c/code\u003e は enable のことで，ファイアウォールを有効にします．\u003c/p\u003e\n\u003ch2 id=\"同じネットワークのアドレスをインターフェイスに振ってはいけない\"\u003e同じネットワークのアドレスをインターフェイスに振ってはいけない\u003c/h2\u003e\n\u003cp\u003e2つ以上のインターフェイスに同じネットワークの IP アドレスを振ると，その設定が無効化され接続できなくなります．\u003c/p\u003e\n\u003cp\u003e同じネットワークに所属させるために bridge 機能があります ( この記事では説明しませんが )．\u003c/p\u003e","title":"OPNsense設定備忘録","created_at":"2021-08-17"}},"__N_SSG":true},"page":"/posts/[year]/[month]/[date]/[id]","query":{"year":"2021","month":"08","date":"17","id":"post01"},"buildId":"IBghKQTQl9mexBDzGCP1b","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>